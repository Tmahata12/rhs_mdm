<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° - RHS MDM System V2.0</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçΩÔ∏è</text></svg>">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Authentication Module -->
    <script src="auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-role {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .btn-logout {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        /* Container */
        .dashboard-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .action-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .action-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .action-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #666;
            font-weight: 500;
        }

        /* Charts Section */
        .charts-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Recent Activity */
        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .activity-user {
            font-weight: 600;
            color: #667eea;
        }

        .activity-action {
            color: #333;
            margin: 5px 0;
        }

        .activity-time {
            font-size: 0.85rem;
            color: #999;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===================================== */
        /* ENHANCED FEATURES STYLES */
        /* ===================================== */
        
        /* Icon Buttons */
        .btn-icon {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-right: 10px;
        }
        
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 380px;
            max-height: 600px;
            overflow: hidden;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .btn-mark-all {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-mark-all:hover {
            background: #764ba2;
        }
        
        .notification-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .notification-item:hover {
            background: #f9f9f9;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .notification-message {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .notification-time {
            color: #999;
            font-size: 11px;
        }
        
        .notification-loading {
            padding: 40px;
            text-align: center;
            color: #999;
        }
        
        /* QR Code Section */
        .qr-section {
            margin-bottom: 30px;
        }
        
        .qr-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .qr-header h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .qr-header p {
            color: #666;
            font-size: 14px;
        }
        
        .qr-display {
            margin: 30px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-display img {
            max-width: 300px;
            border: 4px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            background: white;
        }
        
        .qr-loading {
            color: #999;
            font-size: 14px;
        }
        
        .btn-generate-qr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-generate-qr:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a202c !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode .dashboard-header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%) !important;
        }
        
        .dark-mode .quick-actions,
        .dark-mode .stats-grid,
        .dark-mode .charts-grid,
        .dark-mode .recent-activity {
            background: transparent !important;
        }
        
        .dark-mode .action-card,
        .dark-mode .stat-card,
        .dark-mode .chart-card,
        .dark-mode .qr-card {
            background: #2d3748 !important;
            color: #e2e8f0 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }
        
        .dark-mode .action-title,
        .dark-mode .action-desc,
        .dark-mode .stat-value,
        .dark-mode .stat-label,
        .dark-mode .chart-title,
        .dark-mode h1, .dark-mode h2, .dark-mode h3 {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .section-title {
            color: #cbd5e0 !important;
        }
        
        .dark-mode .notification-panel {
            background: #2d3748 !important;
        }
        
        .dark-mode .notification-item {
            border-bottom-color: #4a5568 !important;
        }
        
        .dark-mode .notification-item:hover {
            background: #374151 !important;
        }
        
        .dark-mode .notification-title {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .notification-message {
            color: #cbd5e0 !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1>üçΩÔ∏è RHS MDM Dashboard</h1>
                <p>Ramnagar High School - Mid-Day Meal Management System V2.0</p>
            </div>
            <div class="header-right">
                <button id="darkModeToggle" class="btn-icon" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    üåô
                </button>
                <button id="notificationBell" class="btn-icon" onclick="toggleNotifications()" title="Notifications">
                    üîî
                    <span id="notificationCount" class="notification-badge" style="display: none;">0</span>
                </button>
                <div class="user-info">
                    <div class="user-name">Loading...</div>
                    <div class="user-role">Role</div>
                </div>
                <button class="btn-logout" onclick="logout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel" style="display: none;">
        <div class="notification-header">
            <h3>üîî Notifications</h3>
            <button onclick="markAllRead()" class="btn-mark-all">Mark all read</button>
        </div>
        <div id="notificationList" class="notification-list">
            <div class="notification-loading">Loading...</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-card" onclick="location.href='app.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="action-icon">üçΩÔ∏è</div>
                <div class="action-title" style="color: white;">MDM Application</div>
                <div class="action-desc" style="color: rgba(255,255,255,0.9);">Main management system</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#formC'">
                <div class="action-icon">üìù</div>
                <div class="action-title">Form C Entry</div>
                <div class="action-desc">Daily attendance entry</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#bank'">
                <div class="action-icon">üè¶</div>
                <div class="action-title">Bank Ledger</div>
                <div class="action-desc">Manage transactions</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#rice'">
                <div class="action-icon">üåæ</div>
                <div class="action-title">Rice Ledger</div>
                <div class="action-desc">Stock management</div>
            </div>
            <div class="action-card" onclick="location.href='app.html#reports'">
                <div class="action-icon">üìä</div>
                <div class="action-title">Reports</div>
                <div class="action-desc">View & export reports</div>
            </div>
            <div class="action-card admin-only" onclick="location.href='user-management.html'">
                <div class="action-icon">üë•</div>
                <div class="action-title">Users</div>
                <div class="action-desc">Manage users</div>
            </div>
            <div class="action-card admin-only" onclick="location.href='activity-logs.html'">
                <div class="action-icon">üìã</div>
                <div class="action-title">Activity Logs</div>
                <div class="action-desc">View system logs</div>
            </div>
        </div>

        <!-- Statistics -->
        <h2 class="section-title">üìä Statistics Overview</h2>
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading statistics...</p>
            </div>
        </div>

        <!-- Charts -->
        <h2 class="section-title">üìà Analytics</h2>
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Monthly Expenses</h3>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Attendance Trends</h3>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- QR Code Quick Entry -->
        <h2 class="section-title">üì± Quick Entry QR Code</h2>
        <div class="qr-section">
            <div class="qr-card">
                <div class="qr-header">
                    <h3>Scan for Today's Entry</h3>
                    <p>Use your mobile device to quickly enter attendance data</p>
                </div>
                <div class="qr-display">
                    <img id="qrCodeImage" src="" alt="QR Code" style="display: none;">
                    <div id="qrLoading" class="qr-loading">Generating QR Code...</div>
                </div>
                <button onclick="generateQRCode()" class="btn-generate-qr">üîÑ Generate New QR</button>
            </div>
        </div>

        <!-- Recent Activity -->
        <h2 class="section-title">üïê Recent Activity</h2>
        <div class="recent-activity" id="recentActivity">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading recent activity...</p>
            </div>
        </div>
    </div>

    <script>
        let expenseChart, attendanceChart;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Wait for auth to initialize
                await authManager.requireAuth();

                // Load statistics
                const stats = await apiCall('/dashboard/stats');
                
                if (stats.success) {
                    displayStatistics(stats.stats);
                    displayRecentActivity(stats.stats.recentActivity);
                    initializeCharts();
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
                authManager.showNotification('Error loading dashboard data', 'error');
            }
        }

        // Display statistics
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value">${stats.formCEntries || 0}</div>
                    <div class="stat-label">Form C Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">‚Çπ${(stats.bankBalance || 0).toLocaleString('en-IN')}</div>
                    <div class="stat-label">Bank Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåæ</div>
                    <div class="stat-value">${(stats.riceStock || 0).toFixed(1)} kg</div>
                    <div class="stat-label">Rice Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíµ</div>
                    <div class="stat-value">‚Çπ${(stats.totalExpenses || 0).toLocaleString('en-IN')}</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                ${authManager.isAdmin() ? `
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value">${stats.users || 0}</div>
                    <div class="stat-label">Active Users</div>
                </div>
                ` : ''}
            `;
        }

        // Display recent activity
        function displayRecentActivity(activities) {
            const activityDiv = document.getElementById('recentActivity');
            
            if (!activities || activities.length === 0) {
                activityDiv.innerHTML = '<p style="text-align: center; color: #999;">No recent activity</p>';
                return;
            }

            activityDiv.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-user">${activity.user?.name || 'Unknown'}</div>
                    <div class="activity-action">${getActivityText(activity)}</div>
                    <div class="activity-time">${formatTime(activity.createdAt)}</div>
                </div>
            `).join('');
        }

        // Get activity text in Bengali
        function getActivityText(activity) {
            const actions = {
                create: '‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                update: '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                delete: '‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßá‡¶õ‡ßá‡¶®',
                login: '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®',
                logout: '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®'
            };

            const modules = {
                formC: 'Form C',
                bank: 'Bank Ledger',
                rice: 'Rice Ledger',
                expense: 'Expense',
                auth: 'Authentication'
            };

            return `${actions[activity.action] || activity.action} ${modules[activity.module] || activity.module}`;
        }

        // Format time
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return `${diff} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ü‡¶ó‡ßá`;
            if (diff < 3600) return `${Math.floor(diff / 60)} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ü‡¶ó‡ßá`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá`;
            return `${Math.floor(diff / 86400)} ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶ó‡ßá`;
        }

        // Initialize charts
        function initializeCharts() {
            // Expense Chart
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(expenseCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Expenses (‚Çπ)',
                        data: [12000, 15000, 13000, 17000, 14000, 16000],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Attendance Chart
            const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(attendanceCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [{
                        label: 'Attendance',
                        data: [450, 470, 465, 480, 475, 460],
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ===================================== 
        // ENHANCED FEATURES FUNCTIONS
        // =====================================
        
        // Dark Mode Toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            // Update button emoji
            document.getElementById('darkModeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
        
        // Apply saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            });
        }
        
        // Notifications System
        let notificationPanelOpen = false;
        
        async function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            notificationPanelOpen = !notificationPanelOpen;
            panel.style.display = notificationPanelOpen ? 'block' : 'none';
            
            if (notificationPanelOpen) {
                await loadNotifications();
            }
        }
        
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications?limit=20', {
                    headers: {
                        'Authorization': `Bearer ${authManager.getToken()}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayNotifications(data.notifications);
                    updateNotificationCount(data.unreadCount);
                }
            } catch (error) {
                console.error('Load notifications error:', error);
                document.getElementById('notificationList').innerHTML = 
                    '<div class="notification-loading">Failed to load notifications</div>';
            }
        }
        
        function displayNotifications(notifications) {
            const listEl = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                listEl.innerHTML = '<div class="notification-loading">No notifications</div>';
                return;
            }
            
            listEl.innerHTML = notifications.map(notif => {
                const time = new Date(notif.createdAt).toLocaleString();
                const readClass = notif.isRead ? '' : 'unread';
                return `
                    <div class="notification-item ${readClass}" onclick="markNotificationRead('${notif._id}')">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-time">${time}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateNotificationCount(count) {
            const badge = document.getElementById('notificationCount');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        async function markNotificationRead(id) {
            try {
                await fetch(`/api/notifications/${id}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authManager.getToken()}`
                    }
                });
                
                await loadNotifications();
            } catch (error) {
                console.error('Mark read error:', error);
            }
        }
        
        async function markAllRead() {
            try {
                await fetch('/api/notifications/read-all', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authManager.getToken()}`
                    }
                });
                
                await loadNotifications();
            } catch (error) {
                console.error('Mark all read error:', error);
            }
        }
        
        // Load notifications every 30 seconds
        setInterval(() => {
            if (!notificationPanelOpen) {
                loadNotifications().catch(err => console.error('Background notification load failed:', err));
            }
        }, 30000);
        
        // QR Code Generation
        async function generateQRCode() {
            const today = new Date().toISOString().split('T')[0];
            const qrImage = document.getElementById('qrCodeImage');
            const qrLoading = document.getElementById('qrLoading');
            
            qrImage.style.display = 'none';
            qrLoading.style.display = 'block';
            
            try {
                const response = await fetch(`/api/qr/daily/${today}`, {
                    headers: {
                        'Authorization': `Bearer ${authManager.getToken()}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    qrImage.src = data.qrCode;
                    qrImage.style.display = 'block';
                    qrLoading.style.display = 'none';
                    console.log('‚úÖ QR Code generated for', data.date);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('QR generation error:', error);
                qrLoading.textContent = 'Failed to generate QR code';
            }
        }
        
        // Auto-generate QR code on page load
        setTimeout(() => {
            generateQRCode().catch(err => console.error('Auto QR generation failed:', err));
        }, 2000);
        
        // Close notification panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationPanel');
            const bell = document.getElementById('notificationBell');
            
            if (notificationPanelOpen && !panel.contains(e.target) && !bell.contains(e.target)) {
                toggleNotifications();
            }
        });

        // Load dashboard on page load
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>
